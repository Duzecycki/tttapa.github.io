<!DOCTYPE HTML>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
    <head>
        <meta charset="UTF-8"/>
        <meta name="author" content="Pieter P"/>
        <link rel="stylesheet" type="text/css" href="/CSS/Pages.css"/>
        <link href='/CSS/roboto.css' rel='stylesheet' type='text/css'/>
        <link href='/CSS/icon.css' rel='stylesheet' type='text/css'/>
        <script type="text/x-mathjax-config">
            MathJax.Hub.Config({
              TeX: { equationNumbers: { autoNumber: "AMS" } },
              "fast-preview": {
                disabled: true
              }
            });
        </script>
        <script type="text/javascript" src="/MathJax/MathJax.js?config=TeX-AMS_SVG"></script>
        <meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0' name='viewport'/>
        <meta name="theme-color" content="#ccc"/>
        <meta name="keywords" content="EMA, Exponential Moving Average, IIR filter, filters, DSP, C++, implementation, algorithm"/>
        <meta name="description" content="A very fast and efficient Exponential Moving Average implementation in C++."/>
        <title>C++ Implementation</title>
    </head>
    <body>
        <nav>
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 48 48" style="position:absolute;top:4px;right: 4px;">
                    <path d="M0 0h48v48h-48z" fill="none"/>
                    <path d="M6 36h36v-4h-36v4zm0-10h36v-4h-36v4zm0-14v4h36v-4h-36z"/>
                </svg>
                <h2><a href="/">Pages</a></h2>
<ul>
  <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a href="/Pages/Arduino">Arduino</a>
  <ul>
    <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a href="/Pages/Arduino/Bootloaders">Bootloaders</a>
    <ul>
    </ul>
    </li>
    <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a href="/Pages/Arduino/ESP8266">ESP8266</a>
    <ul>
      <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a href="/Pages/Arduino/ESP8266/A-Beginner's-Guide">A Beginner's Guide to the ESP8266</a>
      <ul>
      </ul>
      </li>
      <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a href="/Pages/Arduino/ESP8266/Flashing">Flashing</a>
      <ul>
      </ul>
      </li>
    </ul>
    </li>
  </ul>
  </li>
  <li class="expanded"><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a href="/Pages/Mathematics">Mathematics</a>
  <ul>
    <li class="expanded"><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a href="/Pages/Mathematics/Systems-and-Control-Theory">Systems and Control Theory</a>
    <ul>
      <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a href="/Pages/Mathematics/Systems-and-Control-Theory/Analog-Filters">Analog Filters</a>
      <ul>
      </ul>
      </li>
      <li class="expanded"><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a href="/Pages/Mathematics/Systems-and-Control-Theory/Digital-filters">Digital filters</a>
      <ul>
        <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a href="/Pages/Mathematics/Systems-and-Control-Theory/Digital-filters/DTLTI Systems, Transfer Functions, and the Z-transform">DTLTI Systems, Transfer Functions, and the Z-transform</a>
        <ul>
        </ul>
        </li>
        <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a href="/Pages/Mathematics/Systems-and-Control-Theory/Digital-filters/Discretization">Discretization</a>
        <ul>
        </ul>
        </li>
        <li class="expanded"><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a href="/Pages/Mathematics/Systems-and-Control-Theory/Digital-filters/Exponential Moving Average">Exponential Moving Average</a>
        <ul>
        </ul>
        </li>
        <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a href="/Pages/Mathematics/Systems-and-Control-Theory/Digital-filters/Simple Moving Average">Simple Moving Average</a>
        <ul>
        </ul>
        </li>
      </ul>
      </li>
    </ul>
    </li>
  </ul>
  </li>
  <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a href="/Pages/Ubuntu">Ubuntu</a>
  <ul>
    <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a href="/Pages/Ubuntu/Software-Installation">Software Installation</a>
    <ul>
    </ul>
    </li>
  </ul>
  </li>
</ul>

                <i class="material-icons">
                    <a href="/" title="Home">home</a>
                </i>
                <i class="material-icons">
                    <a href="C++Implementation.pdf" title="Download as PDF">get_app</a>
                </i>
                <i class="material-icons">
                    <a href="javascript:window.print()" title="Print this article">print</a>
                </i>
                <i class="material-icons">
                    <a href="https://github.com/tttapa/tttapa.github.io/issues/new" target="_blank" title="Comment or open an issue">report</a>
                </i>
            </div>
        </nav>
        <article>
            <h1 class="title">C++ Implementation</h1>
            <i class="author">Pieter P</i>
            <div>

<h3><a name="dividing-by-powers-of-2" href="#dividing-by-powers-of-2">Dividing by Powers of 2</a></h3>
<p>
    The factor \(\alpha\) in the difference equation of the Exponential Moving 
    Average filter is a number between zero and one. There are two main ways to 
    implement this multiplication by \(\alpha\): Either we use floating point 
    numbers and calculate the multiplication directly, or we use integers, and 
    express the multiplication as a division by \(1/\alpha \gt 1\).<br>
    Both floating point multiplication and integer division are relatively 
    expensive operations, especially on embedded devices or microcontrollers.
</p>
<p>
    We can, however, choose the value for \(\alpha\) in such a way that 
    \(1/\alpha = 2^k, k \in \mathbb{N}\).<br>
    This is useful, because a division by a power of two can be replaced by a 
    very fast right bitshift:
    $$ \alpha \cdot x = \frac{x}{2^k} = x \gg k $$
</p>
<p>
    We can now rewrite the difference equation of the EMA with this optimization
    in mind:
    $$ \begin{split}
       y[n] &amp;= \alpha x[n] + (1 - \alpha) y[n-1] \\
            &amp;= y[n-1] + \alpha \left(x[n] - y[n-1]\right) \\
            &amp;= y[n-1] + \frac{x[n] - y[n-1]}{2^k} \\
            &amp;= y[n-1] + \left(x[n] - y[n-1]\right) \gg k 
       \end{split} $$
</p>
<h4><a name="negative-numbers" href="#negative-numbers">Negative Numbers</a></h4>
<p>
    There's one caveat though: this doesn't work for negative numbers. 
    For example, if we try to calculate the integer division \(-15 / 4\) using 
    this method, we get the following answer:
    $$ \begin{split}
       -15 / 4   &amp;= -15 \cdot 2^{-2} \\
       -15 \gg 2 &amp;= 0b11110001 \gg 2 \\
                 &amp;= 0b11111100 \\
                 &amp;= -4
       \end{split} $$
    This is not what we expected! Integer division in programming languages such
    as C++ returns the quotient truncated towards zero, so we would expect a 
    value of \(-3\). The result is close, but incorrect nonetheless.
</p>
<p>
    This means we'll have to be careful not to use this trick on any negative
    numbers. In our difference equation, both the input \(x[n]\) and the output
    \(y[n]\) will generally be positive numbers, so no problem there, but their
    difference can be negative. 
    This is a problem. We'll have to come up with a different representation of
    the difference equation that doesn't require us to divide any negative 
    numbers:
    $$ \begin{split}
       y[n] &amp;= y[n-1] + \alpha \left(x[n] - y[n-1]\right) \\
       y[n] &amp;= y[n-1] + \frac{x[n] - y[n-1]}{2^k} \\
       2^k y[n] &amp;= 2^k y[n-1] + x[n] - y[n-1] \\
       &amp;\ z[n] \triangleq 2^k y[n] \Leftrightarrow y[n] = 2^{-k} z[n]\\
       z[n] &amp;= z[n-1] + x[n] - 2^{-k} z[n-1]
       \end{split} $$
    We now have to prove that \(z[n-1]\) is greater than or equal to zero. 
    We'll prove this using induction:
    <div style="padding-left: 2em">
        <u>Base case</u>: \(\quad n-1 = -1\)
        <div style="padding: 0.75em">
            The value of \(z[-1]\) is the initial state of the system. We can 
            just choose any value, so we'll pick a value that's greater than or 
            equal to zero: \(z[-1] \ge 0\).
        </div>
        <u>Induction step</u>: \(\quad n\)
        <div style="padding: 0.75em">
            Given that \(z[n-1] \ge 0\), we can now use the difference equation 
            to prove that \(z[n]\) is also greater than zero:<br>
            $$ z[n] = z[n-1] + x[n] - 2^{-k} z[n-1] $$
            We know that the input \(x[n]\) is always zero or positive. <br>
            Since \(k \gt 1 \Rightarrow 2^{-k} \lt 1\), and since \(z[n-1]\) is 
            zero or positive as well, we know that \(z[n-1] \ge 2^{-k} z[n-1] 
            \Rightarrow z[n-1] - 2^{-k} z[n-1] \ge 0\).<br>
            Therefore, the entire right-hand side is always positive or zero, 
            because it is a sum of two numbers that are themselves greater than
            or equal to zero. \(\quad\Box\)
        </div>
    </div>
</p>
<h4><a name="rounding" href="#rounding">Rounding</a></h4>
<p>
    A final improvement we can make to our division algorithm is to round the
    result to the nearest integer, instead of truncating it towards zero.<br>
    Consider the rounded result of the division \(a/b\). We can then express it
    as a flooring of the result plus one half:
    $$ \begin{split} 
       \left\lfloor \frac{a}{b} \right\rceil &amp;= 
           \left\lfloor \frac{a}{b} + \frac{1}{2} \right\rfloor \\
        &amp;= \left\lfloor \frac{a + \frac{b}{2}}{b} \right\rfloor \\
       \end{split} $$
    When \(b\) is a power of two, this is equivalent to:
    $$ \begin{split} 
    \left\lfloor \frac{a}{2^k} \right\rceil &amp;= 
        \left\lfloor \frac{a}{2^k} + \frac{1}{2} \right\rfloor \\
     &amp;= \left\lfloor \frac{a + \frac{2^k}{2}}{2^k} \right\rfloor \\
     &amp;= \left\lfloor \frac{a + 2^{k-1}}{2^k} \right\rfloor \\
     &amp;= \left(a + 1 \ll \left(k-1\right)\right) \gg k \\
    \end{split} $$
</p>
<h3><a name="implementation-in-c" href="#implementation-in-c">Implementation in C++</a></h3>
<p>
    We now have everything in place to write an implementation of the EMA in 
    C++:
    <pre class="lineNumbers" style="color: rgb(0, 0, 0);"><code><code><span style="color: #af00db;">#include</span><span style="color: #0000ff;"> </span><span style="color: #a31515;">&lt;stdint.h&gt;</span></code></code>
<code><code></code></code>
<code><code><span style="color: #0000ff;">template</span><span style="color: #000000;"> &lt;</span><span style="color: #0000ff;">uint8_t </span><span style="color: #267f99;">K</span><span style="color: #000000;">, </span><span style="color: #0000ff;">class </span><span style="color: #267f99;">uint_t</span><span style="color: #000000;">&gt;</span></code></code>
<code><code><span style="color: #0000ff;">class</span><span style="color: #000000;"> </span><span style="color: #267f99;">EMA</span><span style="color: #000000;"> {</span></code></code>
<code><code><span style="color: #000000;">  </span><span style="color: #0000ff;">public:</span></code></code>
<code><code><span style="color: #000000;">    </span><span style="color: #267f99;">uint_t</span><span style="color: #000000;"> </span><span style="color: #795e26;">filter</span><span style="color: #000000;">(</span><span style="color: #267f99;">uint_t</span><span style="color: #000000;"> </span><span style="color: #001080;">x</span><span style="color: #000000;">) {</span></code></code>
<code><code><span style="color: #000000;">        z </span><span style="color: #000000;">+=</span><span style="color: #000000;"> x;</span></code></code>
<code><code><span style="color: #000000;">        </span><span style="color: #267f99;">uint_t</span><span style="color: #000000;"> y </span><span style="color: #000000;">=</span><span style="color: #000000;"> (z </span><span style="color: #000000;">+</span><span style="color: #000000;"> (</span><span style="color: #09885a;">1</span><span style="color: #000000;"> </span><span style="color: #000000;">&lt;&lt;</span><span style="color: #000000;"> (K </span><span style="color: #000000;">-</span><span style="color: #000000;"> </span><span style="color: #09885a;">1</span><span style="color: #000000;">))) </span><span style="color: #000000;">&gt;&gt;</span><span style="color: #000000;"> K;</span></code></code>
<code><code><span style="color: #000000;">        z </span><span style="color: #000000;">-=</span><span style="color: #000000;"> y;</span></code></code>
<code><code><span style="color: #000000;">        </span><span style="color: #af00db;">return</span><span style="color: #000000;"> y;</span></code></code>
<code><code><span style="color: #000000;">    }</span></code></code>
<code><code></code></code>
<code><code><span style="color: #000000;">  </span><span style="color: #0000ff;">private:</span></code></code>
<code><code><span style="color: #000000;">    </span><span style="color: #267f99;">uint_t</span><span style="color: #000000;"> z </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #09885a;">0</span><span style="color: #000000;">;</span></code></code>
<code><code><span style="color: #000000;">};</span></code></code></pre>
    Note how we save \(z[n] - 2^{-k} z[n]\) instead of just \(z[n]\). Otherwise,
    we would have to calculate \(2^{-k} z[n]\) twice (once to calculate 
    \(y[n]\), and once on the next iteration to calculate \(2^{-k} z[n-1]\)),
    and that would be unnecessary.
</p>

</div>
        </article>
        <footer>Last edited: Sunday, 23 June 2019 08:58 UTC</footer>
    </body>
</html>
